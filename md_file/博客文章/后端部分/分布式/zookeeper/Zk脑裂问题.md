## Zookeeper的脑裂问题和为什么多选用奇数个节点







#### 什么叫脑裂？

在zookeeper集群中，有一个leader和多个follower(observer不参与选举，不做考虑)，
leader通过周期性向follower发送心跳的方式维持自己的存在感。

当follower没有收到心跳超过一段时间后，就认为leader已经宕机，开始重新选举。
但是这个时候leader可能并没有宕机，而是假死，比如网络分区情况的出现或者事务阻塞。

举个例子，假设集群有6个节点，发生网络分区后，原本只有一台机器的leader，

但是leader因网络分区导致不通，就迫使其余节点开始选取新的leader,

当剩余节点选出新的leader，原来的leader又恢复工作时，就会有两个leader同时工作，造成“脑裂”现象。



#### 解决方案

为了解决这个问题，zookeeper选举会有过半机制。

即每次选举leader时，同意选举的节点数需要多于集群一半节点数才能当选，等于一半都不行。使用过半机制后，即使像上面那样分成两个集群，机房2由于同意选举的结点数最多只有3个，等于总节点数一半，但是未超过一半，因此无法选出leader，也无法提供服务。机房1的leader通过心跳机制发现自己管理的节点数未过半，会自动退位，至此整个集群无leader，停止服务。但是避免了2个leader分别执行写操作导致不一致的情况。



另外，zookeeper多选用奇数个节点搭建集群，这样的好处是分区后必然有一个机房的节点数是过半的，能够选出leader，因此集群仍然可以对外服务。即zookeeper集群就有了这样的一个特性：集群中只要有过半的机器是正常工作的，那么整个集群对外就是可用的。

这也是为什么平时搭建集群时，多用奇数个数的集群节点数的原因。



深入解析zk的选举原理，可参考博文:

https://www.cnblogs.com/ZhuChangwu/p/11622763.html



