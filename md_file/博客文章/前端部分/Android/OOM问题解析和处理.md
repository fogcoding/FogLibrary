

参考： [OOM问题与加载图片的相关方法-郭霖]（http://blog.csdn.net/guolin_blog/article/details/9316683）



## OOM问题个人笔记



##### OOM问题原因

* (out of memory) 超出程序应用内存。

##### 触发原理

​	此问题多出现在加载大量图片的时候出现，现在摄像头技术先进，随意一张照片就能5M以上，最大的图片甚至能达到几百兆，但是我们的手机能够使用的内存却是相当有限的,一个手机装在相当多的应用，这样一来每个应用能分到的内存可用空间会变得相当小。

​	经过实际测试，本人使用的手机的最大内存是128MB，也就是说，当我们的手机内存里面的实时运行内存不能超过128MB.

​	但是现在实际的安卓开发中，很容易就加载相当多的图片显示，一页几十张的情况也并不稀少，为了保证不出现OOM问题，我们就必须对读取和显示的图片进行缩放处理。

​	比如一个50X50 DP大小的控件，仍然可以设置显示1980×1080大小的图片，这样一来，仅仅50DP的空间就占用了整张超大内存的图片的大小，但是却存在一个问题，在50DP大小的控件上显示的照片效果，50×50像素的图片和1980×1080像素并没有多大的差别，我们所作的处理和优化就是在保证显示效果的情况下，减少不必要的内存支出



#### 图片内存占用的计算规则

---

[参考-裸奔的凯子哥-简书](http://www.jianshu.com/p/312511edf94f)

​	图片内存的计算公式：像素面积*单位像素的字节值

​	eg: 100×100 像素 格式为ARGB，那么该图片的内存占用为：100×100×4 = 40000 byte

​	Android中，图片默认为bitmap格式，bitmap通过设置•Bitmap.Config，可以实现不同的保存形式，每种保存形式的效果和内存占用不同，可根据需要设置

​	具体种类：

* Bitmap.Config.ALPHA_8  只有alpha值，没有RGB值 单位像素=1
* Bitmap.Config.ARGB_4444 alpha(A)值，Red（R）值，Green(G)值，Blue（B）值各占4个bites共16bites 单位像素=2
* Bitmap.Config.ARGB_8888 alpha(A)值，Red（R）值，Green(G)值，Blue（B）值各占8个bites，共32bites,即4个字节 单位像素=4（默认格式）
* Bitmap.Config.RGB_565   没有alpha(A)值，即不支持透明和半透明，Red（R）值占5个bites，Green(G)值占6个bites，Blue（B）值占5个bites,共16bites,即2个字节 单位像素=2



#### 图片在drawable的不同DPI值中的内存的变化情况

---

​	为了实现最佳的显示效果，我们在对应分辨率的屏幕上设计出特定分辨率的图片，这样设计出来的图片在对应屏幕上显示效果是最好的

​	如果这张图片被不同分辨率的屏幕显示，那么实际的分辨率需要根据DP值进行换算，

​	比如说：以160DPI的界面为基础设计的图片分辨率为100*100，我们在480DPI的屏幕上进行显示,那么为了适应480DPI的屏幕，系统就会将那张100×100的图片就需要缩放成（480/160）×（100×100），也就是这张图片会放大三倍，也就是说这张图片在原本就占用内存的情况下会再占用三倍的内存，而且在方大的过程中，非常容易出现失真的情况

​	反过来说，在480DPI的屏幕下完美显示的图片，如果在160DPI的屏幕上显示，系统就会根据需要缩小三倍，但他本身占了自身的内存，然后还需要占有缩放后的1/3的内存，但他又只在160DPI的屏幕上显示，同样造成了三倍的内存浪费

​	为了避免在内存紧张的手机上造成浪费，Android系统给出了不同的缩影文件夹，从hdpi,mdpi```xxxhdpi（这些DPI即代表160到640DPI的屏幕分辨率）,我们可以根据需要给出对应的图片，让系统根据分辨率来找对应的图片，从而避免缩放造成的内存浪费

* 然而不可能完全实现这种定向图片适配，所以我们在实际开发中，就只能在缩小和方法中选一个。

​	考虑到实际情况，480DPI的屏幕是现在市面上最多的，那么我们可以以480DPI为基础设计图片，从硬件角度减少缩放需求，节省内存

​	在方大和缩小过程对比中，方大很有可能会使图片失真，缩小很少有这样的情况，同时，方大占有三倍的运行内存，而缩小占有1/3的运行内存，对同一张照片来说，显然缩小比方大要更加的优越

​	根据上面两点，可以总结为：以市面上手机屏幕比例最大的种类为基础设计图片，并在一定要进行缩放进行适配的时候，优先考虑缩小，一是减少内存支出，二是保证图片不失真

#### [Drawable只有一个文件夹，无法实现对图片DPI分类的解决办法](https://github.com/fogcoding/FogLibrary/blob/master/QuestionAndSolution/Drawable%E5%8F%AA%E6%9C%89%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6%E5%A4%B9%EF%BC%8C%E6%97%A0%E6%B3%95%E5%88%92%E5%88%86%E5%9B%BE%E7%89%87%E7%9A%84DPI%E7%B1%BB%E5%9E%8B.md)



#### 图片缩放的方法

---

* 1.通过decodeSampledBitmapFromResource方法，给出缩放比例进行缩放

* 2.通过matrix对象类进行绘制新的图像，实现缩放



#### 图片的三级缓存

---

* REF: [简书-一只奇思妙想会做梦的喵](http://www.jianshu.com/p/2cd59a79ed4a)

* 简单来说就是：运行内存-->文件存储->网络加载，这样的三级逐步加载过程

  
